import numpy as np
from collections import Counter


def vectorized_knn_predict(email_vector, train_emails, train_norms, train_labels, k):
    email_norm = np.linalg.norm(email_vector)

    if email_norm == 0: return 0, {"0": 1.0, "1": 0.0} #empty/unknown -> so its ham

    #finds cosine similarity between user email and the training emails (1e-12 to ensure it doesn't get divided by zero)
    cos_similarity = (np.dot(train_emails, email_vector)) / (train_norms * email_norm + 1e-12)
    cos_distance = 1 - cos_similarity

    #finds k nearest and counts the votes
    ind = np.argpartition(cos_distance, k-1)[:k]
    votes = train_labels[ind]
    cnt = Counter(votes.tolist())

    fraction_spam = cnt[1] / max(1, cnt[0] + cnt[1])
    fraction_ham = cnt[0] / max(1, cnt[0] + cnt[1])

    #returns whether its spam or ham (1, 0) and the confidence
    if cnt[1] >= cnt[0]:
        return 1, {"0": float(fraction_ham), "1": float(fraction_spam)}
    else:
        return 0, {"0": float(fraction_ham), "1": float(fraction_spam)}
